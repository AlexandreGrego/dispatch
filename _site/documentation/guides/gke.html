<!doctype html>
<html lang="en-US">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    <!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Gke | Dispatch Serverless Framework</title>
<meta property="og:title" content="Gke" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Setting up Dispatch on GKE" />
<meta property="og:description" content="Setting up Dispatch on GKE" />
<link rel="canonical" href="http://localhost:4000/dispatch/documentation/guides/gke" />
<meta property="og:url" content="http://localhost:4000/dispatch/documentation/guides/gke" />
<meta property="og:site_name" content="Dispatch Serverless Framework" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-06-11T14:24:45-07:00" />
<script type="application/ld+json">
{"name":null,"description":"Setting up Dispatch on GKE","author":null,"@type":"BlogPosting","url":"http://localhost:4000/dispatch/documentation/guides/gke","publisher":null,"image":null,"headline":"Gke","dateModified":"2018-06-11T14:24:45-07:00","datePublished":"2018-06-11T14:24:45-07:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/dispatch/documentation/guides/gke"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/dispatch/assets/node_modules/@clr/icons/clr-icons.min.css">
    <script src="/dispatch/assets/node_modules/@webcomponents/custom-elements/custom-elements.min.js"></script>
    <script src="/dispatch/assets/node_modules/@clr/icons/clr-icons.min.js"></script>
    <script src="/dispatch/assets/node_modules/anchor-js/anchor.js"></script>
    <link rel="stylesheet" href="/dispatch/assets/node_modules/@clr/ui/clr-ui.min.css">
    <script defer src="https://use.fontawesome.com/releases/v5.0.7/js/all.js"></script>
    <link rel="stylesheet" href="/dispatch/assets/css/style.css?v=cd131ece455317a0ce1219b8b78ef55e8e6bf546">
    <meta name="viewport" content="width=device-width">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/dispatch/assets/images/dispatch.ico/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/dispatch/assets/images/dispatch.ico/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="/dispatch/assets/images/dispatch.ico/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/dispatch/assets/images/dispatch.ico/favicon-16x16.png" sizes="16x16" />
    <meta name="application-name" content="&nbsp;"/>
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="/dispatch/assets/images/dispatch.ico/mstile-144x144.png" />

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
    <body>
        <clr-main-container class="main-container">
        <clr-header class="header-6 header">
    <button class="header-hamburger-trigger" type="button">
        <span></span>
    </button>

    <div class="branding">
        <a class="logo-and-title" routerlink="/" href="http://github.com/vmware/dispatch">
            <!-- <span class="clr-icon clarity-logo"></span>
            <span class="title">Project Dispatch</span> -->
            <img class="dispatch-logo" src="/dispatch/assets/images/logo-small-200.png">
        </a>
    </div>
    <div class="divider"></div>
    <div class="header-nav clr-nav-level-1">
        <a class="nav-link " id="home-link" routerlink="/" routerlinkactive="active" href="/dispatch/"><span class="nav-text">Home</span></a>
        <a class="nav-link active" routerlink="/documentation" routerlinkactive="active" href="/dispatch/documentation/front/overview"><span class="nav-text">Documentation</span></a>
        <a class="nav-link " routerlink="/code" routerlinkactive="active" href="/dispatch/code"><span class="nav-text">Code</span></a>
        <a class="nav-link " routerlink="/community" routerlinkactive="active" href="/dispatch/community"><span class="nav-text">Community</span></a>
        <a class="nav-link " routerlink="/news" routerlinkactive="active" href="/dispatch/news"><span class="nav-text">What's New</span></a>
    </div>
    <div class="settings">
        <iframe class="github-btn" frameborder="0" height="20px" scrolling="0" src="https://ghbtns.com/github-btn.html?user=vmware&repo=dispatch&type=star&count=true" width="170px"></iframe>
    </div>

    <button class="header-overflow-trigger" type="button">
        <span></span>
    </button>
    <div class="header-backdrop"></div>
</clr-header>

            <documentation class="content-container"><router-outlet></router-outlet>
                <div class="content-area">
                    <section class="dox-content">
                    <h1 id="setting-up-dispatch-on-gke">Setting up Dispatch on GKE</h1>

<p>Google Container Engine (GKE) provides fully managed hosted kubernetes clusters.  This is great environment for running
Dispatch, especially if you’d like Dispatch exposed to the internet.</p>

<p>This guide walks through an installation of Dispatch on GKE with certificates and authorization enabled.  It’s a good
idea to enable authorization as otherwise the Dispatch API is unprotected and on the internet.  Addtionally, enabling
certificates via letsencrypt enables use-cases which require signed certificates (like slack integrations).</p>

<p>The certificate support is pretty experiemental at this point and requires AWS Route53.  Support for other DNS services
is coming.</p>

<h2 id="create-gke-cluster">Create GKE cluster</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export CLUSTER_NAME=dispatch-demo
gcloud container clusters create -m n1-standard-2 --cluster-version 1.9.6-gke.1 ${CLUSTER_NAME}
</code></pre></div></div>

<h2 id="fetch-cluster-credentials">Fetch cluster credentials</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcloud container clusters get-credentials ${CLUSTER_NAME}
</code></pre></div></div>

<p>Kubectl should now be configured to the new cluster:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ kubectl config current-context
gke_dispatch-193801_us-west1-c_dispatch-demo
</code></pre></div></div>

<h2 id="setup-helm-and-tiller">Setup Helm and Tiller</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create clusterrolebinding tiller-cluster-admin --clusterrole=cluster-admin --serviceaccount=kube-system:default
</code></pre></div></div>

<p>The following commands it to work around a known <a href="https://github.com/kubernetes/helm/issues/3409">helm</a>
<a href="https://github.com/kubernetes/helm/issues/3379">issues</a>.  If it fails, retry:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm init --wait
</code></pre></div></div>

<h2 id="create-secret-for-dns-provider">Create Secret for DNS Provider</h2>

<p>Dispatch uses letsencrypt and relies on the DNS challenge type for issuing certificates.  This requirement
will hopefully go away in the near future, but is necessary for now.  Also, additional DNS services may be
supported.</p>

<h3 id="clouddns">CloudDNS</h3>

<p>In order to use CloudDNS, you must first obtain a service account key.  The assocated service account must have
DNS admin rights.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create secret generic clouddns --namespace kube-system --from-literal service-account.json=$GCP_SERVICE_ACCOUNT_KEY
</code></pre></div></div>

<h3 id="route53">Route53</h3>

<p>If you are enabling certificates (and you are using AWS Route53), create the following secret:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create secret generic route53 --namespace kube-system --from-literal secret-access-key=$AWS_SECRET_ACCESS_KEY
</code></pre></div></div>

<h2 id="install-dispatch">Install Dispatch</h2>

<p>Create a installation config as follows, subsituting values where appropriate:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">ingress</span><span class="pi">:</span>
  <span class="na">serviceType</span><span class="pi">:</span> <span class="s">LoadBalancer</span>
<span class="na">apiGateway</span><span class="pi">:</span>
  <span class="na">serviceType</span><span class="pi">:</span> <span class="s">LoadBalancer</span>
  <span class="c1"># A hostname for the API gateway, set this in Route53 when prompted</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s">api-host.example.com</span>
<span class="na">letsEncrypt</span><span class="pi">:</span>
  <span class="c1"># An email address where certificate expiration warnings are sent</span>
  <span class="na">email</span><span class="pi">:</span> <span class="s">user@example.com</span>
  <span class="c1"># Use letsencrypt prod</span>
  <span class="na">staging</span><span class="pi">:</span> <span class="no">false</span>
  <span class="c1"># Default DNS provider is clouddns</span>
  <span class="na">dns</span><span class="pi">:</span>
    <span class="na">provider</span><span class="pi">:</span> <span class="s">clouddns</span>
    <span class="na">clouddns</span><span class="pi">:</span>
      <span class="na">project</span><span class="pi">:</span> <span class="s">example-com</span>
  <span class="c1">#   provider: route53</span>
  <span class="c1">#   # The AWS_ACCESS_KEY_ID associated with the route53 secret set above</span>
  <span class="c1">#   route53:</span>
  <span class="c1">#     accessKeyID: ***********</span>
<span class="na">dispatch</span><span class="pi">:</span>
  <span class="c1"># A hostname for the dispatch API, set this in Route53 when prompted</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s">host.example.com</span>
  <span class="na">port</span><span class="pi">:</span> <span class="s">443</span>
  <span class="na">tls</span><span class="pi">:</span>
    <span class="na">ca</span><span class="pi">:</span> <span class="s">letsEncrypt</span>
  <span class="na">faas</span><span class="pi">:</span> <span class="s">riff</span>
  <span class="na">eventTransport</span><span class="pi">:</span> <span class="s">kafka</span>
  <span class="c1"># Bootstrap user should be the email address of the github user assocated</span>
  <span class="c1"># with the github app (below).  See the [authorization docs]</span>
  <span class="c1"># (https://vmware.github.io/dispatch/documentation/guides/setup-authentication)</span>
  <span class="na">bootstrapUser</span><span class="pi">:</span> <span class="s">user@example.com</span>
  <span class="na">oauth2Proxy</span><span class="pi">:</span>
    <span class="na">provider</span><span class="pi">:</span> <span class="s">github</span>
    <span class="na">clientID</span><span class="pi">:</span> <span class="err">**********</span>
    <span class="na">clientSecret</span><span class="pi">:</span> <span class="err">***********</span>
</code></pre></div></div>

<p>Run the dispatch install command:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dispatch install -f gke-install.yaml --single-namespace=dispatch
Installing cert-manager helm chart
Successfully installed cert-manager chart - cert-manager
Installing charts/certificate helm chart
Successfully installed charts/certificate chart - dispatch-certificate
Installing nginx-ingress helm chart
Successfully installed nginx-ingress chart - ingress
Installing postgresql helm chart
Successfully installed postgresql chart - postgres
Installing charts/kong helm chart
Successfully installed charts/kong chart - api-gateway
Installing kafka helm chart
Successfully installed kafka chart - transport
Installing riff helm chart
Successfully installed riff chart - riff
Installing docker-registry helm chart
Successfully installed docker-registry chart - docker-registry
Installing charts/dispatch helm chart
Successfully installed charts/dispatch chart - dispatch
##############################
Add the following DNS records:
	35.255.3.124		api-host.example.com
	104.2.233.161		host.example.com
##############################
Config file written to: /Users/bjung/.dispatch/config.json
</code></pre></div></div>

<h2 id="add-the-dns-records">Add the DNS Records</h2>

<p>If the install is successful, you should be presented with instructions for updating 2 DNS records.  Add the records
using your DNS provider.</p>

<h2 id="authenticate-and-setup-user-policies">Authenticate and Setup User Policies</h2>

<p><strong>Ensure that the configured <a href="https://github.com/settings/developers">GitHub OAuth App</a>
points to the dispatch hostname (i.e. <code class="highlighter-rouge">host.example.com</code>)</strong></p>

<p>At this point dispatch is installed, but is in “bootstrap mode”.</p>

<p>The following instructions are abbreviated from the
<a href="https://vmware.github.io/dispatch/documentation/guides/setup-authentication">setup authorization guide</a>.
See the guide for more detail and troubleshooting.</p>

<ol>
  <li>Log in to dispatch. If everything is setup correctly you should be redirected to github for authentication:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dispatch login
</code></pre></div>    </div>
  </li>
  <li>Use the email address associated with your GitHub account to create an iam policy:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dispatch iam create policy default-admin-policy --subject github-user@example.com --action "*" --resource "*"
</code></pre></div>    </div>
  </li>
  <li>Validate the policy:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dispatch iam get policy default-admin-policy --wide
       NAME         |         CREATED DATE         |             RULES
----------------------------------------------------------------------------------
  default-admin-policy | Sat Jan  1 10:17:16 PST 0000 | {
                    |                              |   "actions": [
                    |                              |     "*"
                    |                              |   ],
                    |                              |   "resources": [
                    |                              |     "*"
                    |                              |   ],
                    |                              |   "subjects": [
                    |                              |     "github-user@example.com"
                    |                              |   ]
                    |                              | }
</code></pre></div>    </div>
  </li>
  <li>Disable bootstrap mode (you will now have full access to the API - according to the configured policy):</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dispatch manage --disable-bootstrap-mode
</code></pre></div></div>

<blockquote>
  <p><strong>Important</strong>: You will need to wait up to 30 seconds for change to be applied</p>
</blockquote>

                    </section>
                </div>

                <nav class="sidenav clr-nav-level-2">
                    <section class="sidenav-content">
                    

                    
                    
                        <!-- front section is top level and has no label -->
                        <section class="nav-group collapsible">

                        
                            <ul class="nav-list">
                                <documentation-nav-links type="">
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/front/overview">Overview</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/front/roadmap">Roadmap</a></li>
                                
                                
                                </documentation-nav-links>
                            </ul>
                        </section>
                    
                    
                    
                        <!-- front section is top level and has no label -->
                        <section class="nav-group collapsible">

                        
                        
                            
                            <input id="Guides" type="checkbox">
                            
                            <label for="Guides">Guides</label>
                        
                        
                            <ul class="nav-list">
                                <documentation-nav-links type="Guides">
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/guides/building">Building</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/guides/built-in-event-drivers">Built In Event Drivers</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/guides/custom-event-drivers">Custom Event Drivers</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/guides/docker-for-mac">Docker For Mac</a></li>
                                
                                
                                
                                    <li><a class="nav-link active" routerlinkactive="active" href="/dispatch/documentation/guides/gke">Gke</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/guides/minikube">Minikube</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/guides/quickstart">Quickstart</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/guides/setup-authentication">Setup Authentication</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/guides/setup-service-acccount-authentication">Setup Service Acccount Authentication</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/guides/troubleshooting">Troubleshooting</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/guides/working-with-events">Working With Events</a></li>
                                
                                
                                </documentation-nav-links>
                            </ul>
                        </section>
                    
                    
                    
                        <!-- front section is top level and has no label -->
                        <section class="nav-group collapsible">

                        
                        
                            
                            <input id="posts" type="checkbox" checked>
                            
                            <label for="posts">Posts</label>
                        
                        
                            <ul class="nav-list">
                                <documentation-nav-links type="">
                                
                                
                                    <li><a class="nav-link" href="/dispatch/2018/05/23/v0-1-15-release.html">v0.1.15 Dispatch Release</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/2018/06/06/v0-1-16-release.html">v0.1.16 Dispatch Release</a></li>
                                
                                
                                </documentation-nav-links>
                            </ul>
                        </section>
                    
                    
                    
                        <!-- front section is top level and has no label -->
                        <section class="nav-group collapsible">

                        
                        
                            
                            <input id="Specifications" type="checkbox" checked>
                            
                            <label for="Specifications">Specifications</label>
                        
                        
                            <ul class="nav-list">
                                <documentation-nav-links type="Specifications">
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/specs/api-gateway">Api Gateway</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/specs/application">Application</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/specs/development">Development</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/specs/dispatch">Dispatch</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/specs/error-handling">Error Handling</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/specs/event-gateway">Event Gateway</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/specs/event-manager">Event Manager</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/specs/function-gateway">Function Gateway</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/specs/function-schema-validation">Function Schema Validation</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/specs/identity-management">Identity Management</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/specs/image-manager">Image Manager</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/specs/language-support">Language Support</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/specs/rest-api">Rest Api</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/specs/secrets-store">Secrets Store</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/specs/service-manager">Service Manager</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/specs/terminology">Terminology</a></li>
                                
                                
                                </documentation-nav-links>
                            </ul>
                        </section>
                    
                    
                    
                        <!-- front section is top level and has no label -->
                        <section class="nav-group collapsible">

                        
                        
                            
                            <input id="Usage" type="checkbox" checked>
                            
                            <label for="Usage">Usage</label>
                        
                        
                            <ul class="nav-list">
                                <documentation-nav-links type="Usage">
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/usage/api">API Endpoints</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/usage/event-drivers">Events Drivers and Subscriptions</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/usage/functions">Functions</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/usage/iam">Roles and Policies</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/usage/images">Images and Base Images</a></li>
                                
                                
                                
                                    <li><a class="nav-link" href="/dispatch/documentation/usage/services">Services Integration</a></li>
                                
                                
                                </documentation-nav-links>
                            </ul>
                        </section>
                    
                    
                    </section>
                </nav>
            </documentation>
        <footer></footer>
<script>
    anchors.add();
</script>
<script src="/dispatch/assets/js/scale.fix.js"></script>
        </clr-main-container>
    </body>
</html>